name: PR Merge Validator Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions: 
  contents: read
  pull-requests: write

jobs:
  validate-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR for merge readiness
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const mergeable = pr.mergeable;

            if (mergeable === null) {
              throw new Error('Mergeability status is unknown. Please resolve merge conflicts.');
            }

            if (mergeable === false) {
              throw new Error('PR has merge conflicts. Please resolve them before merging.');
            }

            // Optionally, check for required checks or CI status here
            const status = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha
            });

            const allChecksPassed = status.data.every(check => check.conclusion === 'success');
            if (!allChecksPassed) {
              throw new Error('Not all checks have passed. Please ensure all tests are successful.');
            }

            // Success message with an emoji
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: 'âœ… All checks passed! This PR is ready to be merged! ðŸŽ‰'
            });
